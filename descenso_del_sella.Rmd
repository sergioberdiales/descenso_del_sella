---
title: "descenso_del_sella"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Análisis Descenso del Sella

Análisis de resultados históricos del Descenso Internacional del Sella.

Actualmente la información, exceptuando la de los vencedores históricos y la de los últimos años (pdfs con todos los resultados generados por la organización) no es de fácil acceso. Así que la mayor parte del trabajo de este proyecto será buscar y tratar los datos para poder utilizarlos. Gran parte de éstos están incluidos en las memorias anuales de la federación española de piragüismo. Estas memorias están en formato pdf pero las tablas con los resultados son imágenes. 

Cargo los paquetes que voy a necesitar para el análisis:

```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(rvest)
library(lubridate)
```

En la wikipedia hay una tabla con los vencedores en categoría K2 de la prueba: https://es.wikipedia.org/wiki/Descenso_Internacional_del_Sella

Utilizo las funciones del paquete rvest para importar la información de la wikipedia.
Importo toda la entrada de la wikipedia:
```{r }
descenso_wiki <- read_html('https://es.wikipedia.org/wiki/Descenso_Internacional_del_Sella')
# save(descenso_wiki, file = "descenso_wiki.Rdata")
# load(file = "descenso_wiki.Rdata")
```
Localizo las tablas y selecciono la tercera, que es donde están registrados todos los vencedores con sus respectivos tiempos. 
Asigno el data frame resultante a 'vencedores_0':
```{r }
vencedores_0 <- html_nodes(descenso_wiki, "table") %>% .[[3]] %>% html_table(header = TRUE)

```

Echo un vistazo al formato de la tabla:
```{r }
head(vencedores_0)
```
Tenemos que arreglar algún detalle de la tabla. Para empezar el nombre de las variables se encuentra en la primera fila de datos, apareciendo como nombres de las columnas el tipo de competición del inicio de la prueba: 'EXCURSIONES'. Esto último ocurre varias veces a lo largo de la tabla. Cuando cambia el tipo de competición aparece antes una fila con el tipo repetido en cada columna y a continuación otra vez el nombre de las columnas.

Primero, cambio el nombre de las variables, eliminando tildes, la 'ñ' y las minúsculas:
``` {r }
colnames(vencedores_0) <- c("edicion", "ano", "ganadores", "municipio", "tiempo")
```
Y segundo, elimino todas las filas que no recojan los resultados de la prueba.
Para ello primero cambio el formato de la variable 'Año' a 'numeric'.
```{r warning = FALSE}

vencedores_0$ano <- as.numeric(vencedores_0$ano)
```

Al convertir a formato numérico la variable 'ano' R convierte a NA todo lo que no puede convertir en un número. Esto nos puede servir para identificar todas las filas que no nos interesan, quedándonos únicamente con las filas que en la variable 'Año' presentan un número.
```{r }
vencedores_0 <- vencedores_0 %>% filter(!is.na(ano)) 
```
Para recuperar la información del tipo de competición a lo largo de la historia del Descenso creo una nueva variable que la recoja.
Utilizo la función 'cut' para crear un vector llamado 'Tipo' con los tipos de competición para cada rango de años:
```{r }
tipo <- cut(vencedores_0$ano, breaks = c(1929, 1931, 1934, 1950, Inf), labels = c("Excursión", "Provincial", "Nacional", "Internacional"))
```
Convierto el objeto creado en un data frame y lo uno a la tabla 'vencedores_0'
```{r }
tipo <- as.data.frame(tipo)

vencedores_1 <- bind_cols(vencedores_0, tipo)

```
La variable 'Municipio' a partir de  que la competición se convierte en internacional no recoge el municipio origen de los participantes sino el país.
```{r }
summary(as.factor(vencedores_1$municipio))
```
Arreglo esto creando una nueva variable 'pais' donde sólo quede registrado el país y elimino la variable 'municipio'
```{r }
vencedores_1 <- vencedores_1 %>% mutate(pais = ifelse(ano < 1951, "España", municipio))
vencedores_1$municipio <- NULL
```
La variable "tiempo" recoge el tiempo empleado por cada ganador en horas, minutos y segundos. Pero antes de poder utilizar esta información hay que realizar alguna modificación a su formato.

Primero, en la tabla de la wikipedia el autor ha incluido un símbolo "®" a la derecha de los tiempos que supusieron un récord en su momento. Eliminamos este símbolo,
```{r }
vencedores_1$tiempo <- str_replace(vencedores_1$tiempo, "®", "" )
```
Los tiempos de los dos primeros años están en otro formato. Sustituimos sus valores por los correspondientes en h:mm:ss
```{r }
vencedores_1$tiempo[[1]] <- "7:00:00"
vencedores_1$tiempo[[2]] <- "12:00:00"
```
Además hay algún error en el formato del resto de tiempos, en alguna ocasión los ":" son sustituidos por "-" o ".". Lo solucionamos sustituyendo en esta columna todos los "-" y "." por ":".
```{r }
vencedores_1$tiempo <- str_replace(vencedores_1$tiempo, "-", ":" )
vencedores_1$tiempo <- str_replace(vencedores_1$tiempo, "\\.", ":" )
vencedores_2 <- vencedores_1
```
Finalmente convertimos la variable de "character" formato "hora" con la función "hms" del paquete "lubridate"
```{r warning = FALSE}
vencedores_2$tiempo <- hms(vencedores_2$tiempo)
```
